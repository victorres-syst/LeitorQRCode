<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leitor QR + Info Produto</title>
  
  <!-- Manifest PWA inline -->
  <link rel="manifest" href="data:application/manifest+json, %7B%22name%22%3A%22Leitor%20QR%20%2B%20Produto%22%2C%22short_name%22%3A%22QR%20Produto%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23f2f2f2%22%2C%22theme_color%22%3A%22%230078ff%22%2C%22orientation%22%3A%22portrait%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22icons/icon-192.png%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image/png%22%7D%2C%7B%22src%22%3A%22icons/icon-512.png%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image/png%22%7D%5D%7D">

  <style>
    /* Reset b√°sico */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      background: #f2f2f2;
      padding: 20px;
    }

    h1 {
      margin-bottom: 20px;
      color: #333;
    }

    /* √Årea da c√¢mera */
    #camera-container {
      width: 100%;
      max-width: 400px;
      aspect-ratio: 3/4;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    #camera {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Bot√£o */
    button {
      padding: 12px 20px;
      background: #0078ff;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
      margin-bottom: 20px;
    }

    button:hover {
      background: #005fcc;
    }

    /* Resultado */
    #result {
      width: 100%;
      max-width: 400px;
      background: white;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    #qr-result {
      color: #0078ff;
      font-weight: bold;
    }

    #product-info {
      margin-top: 10px;
      font-size: 14px;
      color: #333;
    }
  </style>
</head>
<body>
  <h1>üì± Leitor de QR Code</h1>

  <!-- √Årea do v√≠deo (c√¢mera) -->
  <div id="camera-container">
    <video id="camera" autoplay playsinline></video>
  </div>

  <!-- Bot√£o para iniciar leitura -->
  <button id="start-scan">Iniciar Scanner</button>

  <!-- Resultado da leitura -->
  <div id="result">
    <p><strong>C√≥digo lido:</strong> <span id="qr-result">Nenhum</span></p>
    <div id="product-info"></div>
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script>
    const video = document.getElementById('camera');
    const startScanBtn = document.getElementById('start-scan');
    const qrResult = document.getElementById('qr-result');
    const productInfo = document.getElementById('product-info');

    let scanning = false;
    let stream;

    // Fun√ß√£o para abrir a c√¢mera
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" } // c√¢mera traseira
        });
        video.srcObject = stream;
      } catch (err) {
        alert("Erro ao acessar a c√¢mera: " + err);
      }
    }

    // Fun√ß√£o para iniciar o scanner
    function startScanner() {
      if (scanning) return;
      scanning = true;

      const canvas = document.createElement("canvas");
      const context = canvas.getContext("2d");

      function scan() {
        if (!scanning) return;

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);

        if (code) {
          scanning = false;
          qrResult.textContent = code.data;
          fetchProductInfo(code.data); // Chama API com o valor lido
        } else {
          requestAnimationFrame(scan);
        }
      }

      scan();
    }

    // Fun√ß√£o que chama a API de livros (OpenLibrary)
    async function fetchProductInfo(isbn) {
      productInfo.innerHTML = "<p>üîÑ Buscando informa√ß√µes...</p>";

      try {
        const res = await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${isbn}&format=json&jscmd=data`);
        const data = await res.json();

        if (Object.keys(data).length === 0) {
          productInfo.innerHTML = "<p>‚ùå Nenhuma informa√ß√£o encontrada.</p>";
          return;
        }

        const book = data[`ISBN:${isbn}`];
        productInfo.innerHTML = `
          <h3>${book.title}</h3>
          <p><strong>Autor:</strong> ${book.authors ? book.authors[0].name : "N√£o dispon√≠vel"}</p>
          <p><strong>Publicado em:</strong> ${book.publish_date || "N√£o informado"}</p>
          ${book.cover ? `<img src="${book.cover.medium}" alt="Capa do livro">` : ""}
        `;
      } catch (err) {
        productInfo.innerHTML = "<p>‚ö†Ô∏è Erro ao buscar informa√ß√µes.</p>";
      }
    }

    // Inicia c√¢mera ao abrir
    startCamera();

    // Clique do bot√£o
    startScanBtn.addEventListener("click", startScanner);

    // Registro do Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').then(() => {
        console.log('Service Worker registrado!');
      });
    }
  </script>

  <!-- Service Worker inline via blob -->
  <script>
    const swCode = `
      const CACHE_NAME = "qr-pwa-cache-v1";
      const urlsToCache = ["/"];

      self.addEventListener("install", (event) => {
        event.waitUntil(
          caches.open(CACHE_NAME).then((cache) => cache.addAll(urlsToCache))
        );
      });

      self.addEventListener("activate", (event) => {
        event.waitUntil(
          caches.keys().then((cacheNames) =>
            Promise.all(
              cacheNames.map((cache) => {
                if (cache !== CACHE_NAME) return caches.delete(cache);
              })
            )
          )
        );
      });

      self.addEventListener("fetch", (event) => {
        event.respondWith(
          caches.match(event.request).then((response) => response || fetch(event.request))
        );
      });
    `;
    const blob = new Blob([swCode], { type: 'application/javascript' });
    const swURL = URL.createObjectURL(blob);
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register(swURL);
    }
  </script>
</body>
</html>
